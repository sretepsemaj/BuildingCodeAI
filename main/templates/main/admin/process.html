{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>Upload and Process Images</h2>

    <!-- Upload Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Upload Images</h5>
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="images" class="form-label">Select Images</label>
                    <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                </div>
                <div id="preview" class="mb-3"></div>
                <div class="progress mb-3 d-none">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
        </div>
    </div>

    <!-- Process Button -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Process Uploaded Images</h5>
            <p>Click the button below to process all uploaded images and generate the final JSON.</p>
            <button id="processButton" class="btn btn-success">Start Processing</button>
            <div id="processStatus" class="mt-3"></div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const preview = document.getElementById('preview');
    const progress = document.querySelector('.progress');
    const progressBar = document.querySelector('.progress-bar');
    const processButton = document.getElementById('processButton');
    const processStatus = document.getElementById('processStatus');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // File Upload Preview
    document.getElementById('images').addEventListener('change', function(e) {
        preview.innerHTML = '';
        for (const file of this.files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML += `
                    <div class="preview-image mb-2">
                        <img src="${e.target.result}" style="max-height: 100px; margin-right: 10px;">
                        <span>${file.name}</span>
                    </div>
                `;
            }
            reader.readAsDataURL(file);
        }
    });

    // File Upload Handler
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('csrfmiddlewaretoken', csrfToken);

        progress.classList.remove('d-none');
        progressBar.style.width = '0%';

        try {
            const response = await fetch('/process/', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert('Upload successful!');
                preview.innerHTML = '';
                form.reset();
            } else {
                alert('Upload failed: ' + result.message);
            }
        } catch (error) {
            alert('Error uploading files: ' + error);
        } finally {
            progress.classList.add('d-none');
        }
    });

    // Process Button Handler
    processButton.addEventListener('click', async function() {
        processButton.disabled = true;
        processStatus.innerHTML = '<div class="alert alert-info">Processing started...</div>';

        try {
            const response = await fetch('/process/start/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (result.status === 'success') {
                processStatus.innerHTML = '<div class="alert alert-success">Processing completed! <a href="/batch_chapters/" class="alert-link">View Results</a></div>';
            } else {
                processStatus.innerHTML = '<div class="alert alert-danger">Processing failed: ' + result.message + '</div>';
            }
        } catch (error) {
            processStatus.innerHTML = '<div class="alert alert-danger">Error during processing: ' + error + '</div>';
        } finally {
            processButton.disabled = false;
        }
    });
});
</script>
{% endblock %}
{% endblock %}
